import java.time.*

pipeline {
    agent any

    environment {
        DATE_NOW = ''
        DOCKER_TAG = ''
        REPOSITORY_URI = "backend-security"
        REPOSITORY_URI_APP = ""
    }

    stages {
        stage('Construyendo Tag') {
            steps {
                script {
                    def now = new Date()
                    DATE_NOW = now.format("yyMMdd.HHmm", TimeZone.getTimeZone('UTC'))
                    DOCKER_TAG = "$DATE_NOW.$BUILD_NUMBER"
                    REPOSITORY_URI_APP = "$REPOSITORY_URI:$DOCKER_TAG"
                    echo "üïí Fecha actual: ${DATE_NOW}"
                    echo "üè∑Ô∏è Tag generado: ${REPOSITORY_URI_APP}"
                }
            }
        }

        stage('Compilando Proyecto') {
            steps {
                dir('backend_lista_compras') {
                    echo '‚öôÔ∏è Compilando el proyecto con Maven...'
                    sh './mvnw clean package -DskipTests'
                }
            }
        }

        stage('Desplegando con Docker Compose') {
            steps {
                script {
                    echo "üöÄ Iniciando despliegue con Docker Compose..."
                    echo "üì¶ Usando imagen: ${REPOSITORY_URI_APP}"
                    sh """
                        CONTAINER_IMAGE=${REPOSITORY_URI_APP} \
                        docker compose -f ./backend_lista_compras/docker-compose.yml up -d --build
                        docker image prune -f
                    """
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ Despliegue exitoso.'
        }
        failure {
            echo '‚ùå Error durante la ejecuci√≥n del pipeline. Verifica los logs en Jenkins.'
        }
    }
}
