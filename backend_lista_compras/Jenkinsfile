import java.time.*
import java.time.format.DateTimeFormatter

pipeline {
    agent any

    environment {
        REPOSITORY_URI = "backend-security"
    }

    stages {
        stage('Construyendo Tag') {
            steps {
                script {
                    def now = new Date()
                    def dateNow = now.format("yyMMdd.HHmm", TimeZone.getTimeZone('UTC'))
                    def dockerTag = "${dateNow}.${BUILD_NUMBER}"
                    def repositoryUriApp = "${REPOSITORY_URI}:${dockerTag}"

                    env.DATE_NOW = dateNow
                    env.DOCKER_TAG = dockerTag
                    env.REPOSITORY_URI_APP = repositoryUriApp

                    echo "üïí Fecha actual: ${DATE_NOW}"
                    echo "üè∑Ô∏è Tag generado: ${REPOSITORY_URI_APP}"
                }
            }
        }

        stage('Desplegando con Docker Compose') {
            steps {
                script {
                    echo "üöÄ Iniciando despliegue con Docker Compose..."
                    echo "üì¶ Usando imagen: ${REPOSITORY_URI_APP}"

                    // Desplegar el backend usando el docker-compose de la carpeta backend_lista_compras
                    sh """
                        CONTAINER_IMAGE=${REPOSITORY_URI_APP} \
                        docker compose -f ./backend_lista_compras/docker-compose.yml up -d --build
                    """

                    // Limpiar im√°genes antiguas
                    sh "docker image prune -f"

                    echo "‚úÖ Despliegue completado correctamente."
                }
            }
        }
    }

    post {
        success {
            echo "üéâ Pipeline completado exitosamente: ${REPOSITORY_URI_APP}"
            sh "docker ps"
        }
        failure {
            echo "‚ùå Error durante la ejecuci√≥n del pipeline. Verifica los logs en Jenkins."
        }
    }
}
